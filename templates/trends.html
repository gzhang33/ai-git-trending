<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>技术趋势分析</title>
  <!-- 外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1', secondary: '#8b5cf6', accent: '#ec4899',
            dark: '#1e293b', light: '#f8fafc'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          },
          animation: {
            'fadeInUp': 'fadeInUp 0.5s ease forwards',
          },
          keyframes: {
            fadeInUp: {
              from: { opacity: 0, transform: 'translateY(20px)' },
              to: { opacity: 1, transform: 'translateY(0)' },
            }
          }
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .card-border { border: 1px solid rgba(255, 255, 255, 0.08); }
      .glass-effect { backdrop-filter: blur(12px); background: rgba(30, 41, 59, 0.7); }
      .text-gradient { background-clip: text; -webkit-background-clip: text; color: transparent; background-image: linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899); }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
      ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-dark to-slate-900 text-light min-h-screen font-sans">
  <!-- 顶部导航栏 -->
  <header class="glass-effect sticky top-0 z-50 border-b border-white/10">
    <div class="container mx-auto px-4 py-5 flex justify-between items-center">
      <a href="/" class="flex items-center space-x-3">
        <div class="bg-gradient-to-br from-primary to-secondary p-2 rounded-lg shadow-lg">
          <i class="fa fa-github text-white text-2xl"></i>
        </div>
        <h1 class="text-[clamp(1.5rem,3vw,2.2rem)] font-bold">
          <span class="text-gradient">GitHub每周热门项目</span>
        </h1>
      </a>
      <div class="flex items-center space-x-6">
        <a href="/trends" class="text-white font-bold border-b-2 border-primary pb-1">技术趋势</a>
        <div class="relative group">
          <button class="bg-gradient-to-r from-primary to-secondary px-5 py-2 rounded-lg font-medium transition-all shadow-lg hover:shadow-primary/30 flex items-center cursor-pointer">
            <i class="fa fa-weixin mr-2"></i>扫码关注
          </button>
          <div class="absolute hidden group-hover:block right-0 w-40 bg-light p-2 rounded-lg shadow-xl z-50 top-full mt-2">
            <img src="/images/wechat.png" alt="微信公众号二维码" class="w-full rounded">
            <p class="text-center text-sm text-dark mt-1">扫码关注</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-12">
    <section class="mb-12 text-center">
      <h2 class="text-[clamp(1.8rem,4vw,3rem)] font-bold mb-4">技术趋势洞察</h2>
      <p class="text-slate-400 max-w-2xl mx-auto mb-8 text-lg">基于历史数据分析 GitHub 的技术热点、蹿升项目和语言趋势。</p>
    </section>

    <div id="loading-indicator" class="text-center py-16">
        <p class="text-slate-400 text-lg">正在加载趋势数据...</p>
    </div>

    <div id="trends-content" class="hidden space-y-12">
        <!-- 热门项目和语言 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-slate-800/50 p-6 rounded-2xl card-border animate-fadeInUp">
                <h3 class="text-xl font-bold mb-4">热门项目 (近7天)</h3>
                <div class="chart-container">
                    <canvas id="frequentProjectsChart"></canvas>
                </div>
            </div>
            <div class="bg-slate-800/50 p-6 rounded-2xl card-border animate-fadeInUp" style="animation-delay: 0.1s;">
                <h3 class="text-xl font-bold mb-4">热门语言 (近7天)</h3>
                <div class="chart-container">
                    <canvas id="frequentLanguagesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 蹿升项目 -->
        <div class="bg-slate-800/50 p-6 rounded-2xl card-border animate-fadeInUp" style="animation-delay: 0.2s;">
            <h3 class="text-xl font-bold mb-4">星标蹿升最快项目 (近7天)</h3>
            <ul id="surgingProjectsList" class="space-y-3">
                <!-- Surging projects will be loaded here -->
            </ul>
        </div>
    </div>
  </main>

  <script>
    // Chart.js 全局配置
    Chart.defaults.color = 'rgba(255, 255, 255, 0.7)';
    Chart.defaults.font.family = 'Inter, sans-serif';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

    document.addEventListener('DOMContentLoaded', function() {
        const loadingIndicator = document.getElementById('loading-indicator');
        const trendsContent = document.getElementById('trends-content');

        fetch('/api/trends')
            .then(response => response.json())
            .then(data => {
                loadingIndicator.classList.add('hidden');
                trendsContent.classList.remove('hidden');

                if (data.most_frequent_projects && data.most_frequent_projects.length > 0) {
                    renderFrequentProjectsChart(data.most_frequent_projects);
                    renderFrequentLanguagesChart(data.most_frequent_languages);
                    renderSurgingProjects(data.surging_projects);
                } else {
                    trendsContent.innerHTML = '<div class="text-center py-16"><p class="text-slate-400 text-lg">暂无足够历史数据进行分析，请先运行数据抓取任务。</p></div>';
                }
            })
            .catch(error => {
                console.error("Error fetching trends data:", error);
                loadingIndicator.classList.add('hidden');
                trendsContent.innerHTML = '<div class="text-center py-16"><p class="text-red-400 text-lg">加载趋势数据失败，请检查后台服务。</p></div>';
            });
    });

    function renderFrequentProjectsChart(projectData) {
        const ctx = document.getElementById('frequentProjectsChart');
        if (!ctx) return;
        new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: projectData.map(p => p[0]),
                datasets: [{
                    label: '上榜次数',
                    data: projectData.map(p => p[1]),
                    backgroundColor: 'rgba(99, 102, 241, 0.5)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                    y: { grid: { display: false } }
                }
            }
        });
    }

    function renderFrequentLanguagesChart(languageData) {
        const ctx = document.getElementById('frequentLanguagesChart');
        if (!ctx) return;
        new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: languageData.map(l => l[0]),
                datasets: [{
                    label: '上榜次数',
                    data: languageData.map(l => l[1]),
                    backgroundColor: 'rgba(236, 72, 153, 0.5)',
                    borderColor: 'rgba(236, 72, 153, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                    y: { grid: { display: false } }
                }
            }
        });
    }

    function renderSurgingProjects(surgingData) {
        const list = document.getElementById('surgingProjectsList');
        if (!list) return;
        list.innerHTML = '';
        if (surgingData.length === 0) {
            list.innerHTML = '<li>暂无星标数明显蹿升的项目。</li>';
            return;
        }
        surgingData.forEach(project => {
            const item = document.createElement('li');
            item.className = 'flex items-center justify-between bg-slate-900/50 p-3 rounded-lg';
            item.innerHTML = `
                <span class="font-medium">${project.name}</span>
                <span class="text-green-400 font-bold">+${project.star_increase} ✨</span>
            `;
            list.appendChild(item);
        });
    }
  </script>
</body>
</html>
